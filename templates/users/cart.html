{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
	<h2 class="text-3xl font-bold mb-8">Your Cart</h2>
	{% if cart_items %}
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
			<!-- Cart items list column -->
			<div class="lg:col-span-2">
				<div class="bg-white rounded-lg shadow-lg overflow-hidden">
					<div class="p-6">
						<div class="overflow-x-auto">
							<table class="min-w-full divide-y divide-gray-200">
								<thead class="bg-gray-50">
									<tr>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
									</tr>
								</thead>
								<tbody class="bg-white divide-y divide-gray-200">
									{% for item in cart_items %}
									<tr id="cart-item-{{ item.id }}">
										<td class="px-6 py-4 whitespace-nowrap">{{ item.menu_item.name }}</td>
										<td class="px-6 py-4 whitespace-nowrap">{{ item.size.get_size_display }}</td>
										<td class="px-6 py-4 whitespace-nowrap item-price">{{ item.size.price }} VND</td>
										<td class="px-6 py-4 whitespace-nowrap">
											<div class="flex items-center border rounded-lg max-w-[150px]">
												<button type="button" 
														class="px-3 py-1 text-gray-600 hover:text-gray-800" 
														onclick="updateQuantity({{ item.id }}, Math.max(1, {{ item.quantity }} - 1))">âˆ’</button>
												<input type="number" 
													   value="{{ item.quantity }}" 
													   min="1" 
													   class="w-16 text-center border-x px-2 py-1 focus:outline-none quantity-input"
													   onchange="updateQuantity({{ item.id }}, this.value)"
													   data-item-id="{{ item.id }}">
												<button type="button" 
														class="px-3 py-1 text-gray-600 hover:text-gray-800" 
														onclick="updateQuantity({{ item.id }}, {{ item.quantity }} + 1)">+</button>
											</div>
										</td>
										<td class="px-6 py-4 whitespace-nowrap item-total">{{ item.get_total }} VND</td>
										<td class="px-6 py-4 whitespace-nowrap">
											<button onclick="removeItem({{ item.id }})" 
													class="text-red-600 hover:text-red-800">
												<i class="fas fa-trash"></i>
											</button>
										</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>

			<!-- Order summary column -->
			<div class="lg:col-span-1">
				<div class="bg-white rounded-lg shadow-lg p-6">
					<h5 class="text-xl font-semibold mb-4">Order Summary</h5>
					<div class="space-y-3">
						<div class="flex justify-between">
							<span class="text-gray-600">Subtotal:</span>
							<span class="font-medium subtotal-amount">{{ total }} VND</span>
						</div>
						{% if discount %}
						<div class="flex justify-between text-green-600">
							<span>Discount:</span>
							<span class="discount-amount">-{{ discount }} VND</span>
						</div>
						{% endif %}
						<div class="border-t pt-3">
							<div class="flex justify-between font-bold">
								<span>Total:</span>
								<span class="total-amount">{{ total }} VND</span>
							</div>
						</div>
						<a href="{% url 'checkout' %}" 
						   class="w-full flex justify-center items-center px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-200 mt-4">
							<i class="fas fa-shopping-cart mr-2"></i>Proceed to Checkout
						</a>
					</div>
				</div>
			</div>
		</div>
	{% else %}
		<div class="text-center py-12">
			<i class="fas fa-shopping-cart text-6xl text-gray-400 mb-4"></i>
			<p class="text-xl text-gray-600 mb-6">Your cart is empty</p>
			<a href="{% url 'menu-list' %}" 
			   class="inline-flex items-center px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-200">
				<i class="fas fa-coffee mr-2"></i>Browse Menu
			</a>
		</div>
	{% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return;
    
    const formData = new FormData();
    formData.append('quantity', newQuantity);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/users/cart/update-quantity/${itemId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`cart-item-${itemId}`);
            const quantityInput = row.querySelector('.quantity-input');
            const itemTotal = row.querySelector('.item-total');
            
            quantityInput.value = newQuantity;
            itemTotal.textContent = `${data.item_total} VND`;
            
            document.querySelector('.subtotal-amount').textContent = `${data.subtotal} VND`;
            
            if (data.discount > 0) {
                const discountElement = document.querySelector('.discount-amount');
                if (discountElement) {
                    discountElement.textContent = `-${data.discount} VND`;
                }
            }
            
            document.querySelector('.total-amount').textContent = `${data.total} VND`;
            
            showAlert('Quantity updated successfully', 'success');
        } else {
            showAlert(data.error || 'Error updating quantity', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating quantity', 'error');
    });
}

function removeItem(itemId) {
    if (!confirm('Are you sure you want to remove this item?')) return;
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/users/cart/remove/${itemId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`cart-item-${itemId}`);
            row.remove();
            
            if (document.querySelectorAll('tr[id^="cart-item-"]').length === 0) {
                window.location.reload();
            } else {
                showAlert('Item removed successfully', 'success');
            }
        } else {
            showAlert(data.error || 'Error removing item', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error removing item', 'error');
    });
}

function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} z-50`;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

// Prevent manual input of negative numbers
document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('input', function() {
        if (this.value < 1) this.value = 1;
    });
});
</script>
{% endblock %}